<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æˆæœç‰©ä¸€è¦§ç®¡ç†</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap');
  :root {
    --bg:#0f1117; --surface:#1a1d27; --surface2:#22263a; --border:#2e3350;
    --accent:#4f8ef7; --accent2:#7c5af0; --success:#22c97a; --warn:#f59e0b;
    --danger:#ef4444; --text:#e8eaf6; --muted:#7b82a8;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);font-size:13px;}

  /* HEADER */
  .header{background:var(--surface);border-bottom:1px solid var(--border);padding:10px 20px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:100;}
  .header-title{font-size:15px;font-weight:700;color:var(--accent);}
  .pj-badge{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:3px 10px;font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--muted);}
  .type-tag{padding:2px 9px;border-radius:20px;font-weight:700;font-size:11px;}
  .type-info{background:#1a3a5c;color:#60b4f7;border:1px solid #2a5a9c;}
  .type-ctrl{background:#1f2a1a;color:#6ac97a;border:1px solid #2a4a2a;}
  .save-btn{margin-left:auto;background:var(--accent);color:#fff;border:none;border-radius:6px;padding:6px 16px;font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;font-family:'Noto Sans JP',sans-serif;}
  .save-btn:hover{background:#6fa3fa;}
  .home-btn{background:var(--surface2);color:var(--muted);border:1px solid var(--border);border-radius:6px;padding:6px 14px;font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;font-family:'Noto Sans JP',sans-serif;text-decoration:none;display:inline-flex;align-items:center;gap:5px;}
  .home-btn:hover{border-color:var(--accent);color:var(--accent);}

  /* LAYOUT */
  .layout{display:flex;height:calc(100vh - 49px);}

  /* SIDEBAR */
  .sidebar{width:174px;min-width:174px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:10px 0;overflow-y:auto;}
  .sidebar-label{font-size:10px;color:var(--muted);padding:0 12px 6px;letter-spacing:.1em;text-transform:uppercase;}
  .phase-item{padding:9px 12px;cursor:pointer;display:flex;align-items:center;gap:7px;border-left:3px solid transparent;transition:all .12s;color:var(--muted);}
  .phase-item:hover{background:var(--surface2);color:var(--text);}
  .phase-item.active{border-left-color:var(--accent);background:var(--surface2);color:var(--text);}
  .phase-code{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--accent);min-width:14px;}
  .phase-name{font-size:12px;flex:1;}
  .phase-badge{font-size:10px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1px 5px;font-family:'JetBrains Mono',monospace;}
  .phase-badge.all-done{background:#0e3020;color:var(--success);border-color:#1a5030;}

  /* MAIN */
  .main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}

  /* TOOLBAR */
  .toolbar{background:var(--surface);border-bottom:1px solid var(--border);padding:8px 14px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
  .filter-group{display:flex;align-items:center;gap:5px;}
  .filter-label{font-size:11px;color:var(--muted);}
  .filter-btn{padding:3px 9px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:11px;cursor:pointer;transition:all .12s;font-family:'Noto Sans JP',sans-serif;}
  .filter-btn:hover{border-color:var(--accent);color:var(--text);}
  .filter-btn.active{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:700;}
  .divider{width:1px;height:18px;background:var(--border);margin:0 2px;}
  .search-input{background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:4px 9px;color:var(--text);font-size:12px;font-family:'Noto Sans JP',sans-serif;width:160px;}
  .search-input:focus{outline:none;border-color:var(--accent);}
  .add-btn{margin-left:auto;background:var(--surface2);border:1px dashed var(--border);border-radius:4px;color:var(--muted);padding:4px 12px;font-size:12px;cursor:pointer;transition:all .12s;font-family:'Noto Sans JP',sans-serif;}
  .add-btn:hover{border-color:var(--accent);color:var(--accent);}
  .stats{font-size:11px;color:var(--muted);}
  .stats span{color:var(--accent);font-weight:700;}

  /* TABLE */
  .table-wrap{flex:1;overflow-y:auto;}
  table{width:100%;border-collapse:collapse;}
  thead{position:sticky;top:0;z-index:10;}
  th{background:var(--surface2);border-bottom:1px solid var(--border);padding:7px 9px;text-align:left;font-size:11px;color:var(--muted);font-weight:500;white-space:nowrap;}
  tr.row{border-bottom:1px solid var(--border);transition:background .1s;cursor:pointer;}
  tr.row:hover{background:var(--surface2);}
  tr.row.required{background:rgba(79,142,247,.04);}
  tr.row.required:hover{background:rgba(79,142,247,.09);}
  tr.row.selected-row{background:rgba(79,142,247,.13) !important;outline:1px solid var(--accent);}
  tr.row.deprecated{opacity:.4;}
  tr.row.deprecated td{text-decoration:line-through;}
  td{padding:7px 9px;vertical-align:middle;}

  /* BADGES */
  input[type="checkbox"]{width:14px;height:14px;accent-color:var(--accent);cursor:pointer;}
  .req-badge{display:inline-block;font-size:10px;padding:1px 6px;border-radius:3px;font-weight:700;}
  .req-required{background:rgba(79,142,247,.15);color:var(--accent);}
  .req-optional{background:var(--surface2);color:var(--muted);}
  .sys-tag{display:inline-block;font-size:10px;padding:1px 6px;border-radius:3px;font-weight:700;}
  .sys-info{background:#1a3a5c;color:#60b4f7;}
  .sys-ctrl{background:#1f2a1a;color:#6ac97a;}
  .sys-both{background:#2a2040;color:#b48af7;}
  .ver-badge{display:inline-flex;align-items:center;gap:3px;font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;padding:2px 7px;border-radius:4px;background:var(--surface2);color:var(--muted);border:1px solid var(--border);}
  .ver-badge.latest{background:#0e3020;color:var(--success);border-color:#1a5030;}
  .ver-badge.outdated{background:#3a1f00;color:var(--warn);border-color:#6b3a00;}
  .state-badge{display:inline-block;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:700;white-space:nowrap;}
  .state-none   {background:var(--surface2);color:var(--muted);border:1px solid var(--border);}
  .state-wip    {background:#1a3010;color:#7dd060;border:1px solid #2a5020;}
  .state-wf     {background:#1a2a50;color:#60a4f7;border:1px solid #2a4a80;}
  .worker-cell{font-size:11px;color:var(--muted);white-space:nowrap;}
  .path-cell{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--success);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .editable-name{background:transparent;border:none;color:var(--text);font-size:13px;font-family:'Noto Sans JP',sans-serif;width:100%;padding:2px 4px;border-radius:3px;}
  .editable-name:hover{background:var(--surface2);}
  .editable-name:focus{outline:1px solid var(--accent);background:var(--surface2);}
  .share-icon{color:var(--warn);font-size:12px;}

  /* SUMMARY BAR */
  .summary-bar{background:var(--surface2);border-top:1px solid var(--border);padding:6px 14px;display:flex;align-items:center;gap:18px;font-size:11px;color:var(--muted);}
  .summary-item{display:flex;align-items:center;gap:4px;}
  .sc{font-family:'JetBrains Mono',monospace;font-weight:600;}
  .c-accent{color:var(--accent);}
  .c-success{color:var(--success);}
  .c-warn{color:var(--warn);}
  .progress-wrap{flex:1;background:var(--border);border-radius:3px;height:4px;overflow:hidden;margin-left:auto;max-width:180px;}
  .progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width .3s;}

  /* DETAIL PANEL */
  .detail-panel{width:480px;min-width:480px;background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:width .2s;}
  .detail-panel.hidden{width:0;min-width:0;overflow:hidden;}
  .detail-header{padding:11px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-shrink:0;}
  .detail-title{font-size:13px;font-weight:700;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .detail-close{background:transparent;border:none;color:var(--muted);font-size:16px;cursor:pointer;padding:2px 6px;border-radius:3px;}
  .detail-close:hover{color:var(--text);background:var(--surface2);}

  /* WF TAB */
  .wf-body{flex:1;overflow-y:auto;padding:14px;}
  .section-title{font-size:10px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:8px;font-weight:700;}
  .wf-status-bar{display:flex;align-items:center;gap:10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;margin-bottom:16px;}
  .wf-cur-status{font-size:12px;font-weight:700;}
  .wf-cur-ver{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--muted);}
  .wf-status-tag{margin-left:auto;font-size:11px;font-weight:700;padding:3px 10px;border-radius:10px;}
  .wf-st-none    {background:var(--surface);color:var(--muted);border:1px solid var(--border);}
  .wf-st-progress{background:rgba(79,142,247,.15);color:var(--accent);}
  .wf-st-approved{background:rgba(34,201,122,.15);color:var(--success);}
  .wf-st-rejected{background:rgba(239,68,68,.15);color:var(--danger);}

  /* FORM */
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
  .form-grid.full{grid-template-columns:1fr;}
  .field-group{margin-bottom:0;}
  .field-label{font-size:10px;color:var(--muted);margin-bottom:4px;letter-spacing:.05em;display:flex;align-items:center;gap:4px;}
  .field-label .req-mark{color:var(--danger);font-size:11px;}
  .field-input,.field-select,.field-textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:6px 8px;color:var(--text);font-size:12px;font-family:'Noto Sans JP',sans-serif;}
  .field-input:focus,.field-select:focus,.field-textarea:focus{outline:none;border-color:var(--accent);}
  .field-textarea{resize:vertical;min-height:60px;}
  .field-input-row{display:flex;gap:6px;}
  .field-input-row .field-input{flex:1;}
  .field-input-row .unit{font-size:11px;color:var(--muted);align-self:center;white-space:nowrap;}
  .attach-row{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:6px 10px;margin-bottom:6px;}
  .attach-label{flex:1;font-size:12px;}
  .attach-req{font-size:10px;font-weight:700;padding:1px 6px;border-radius:3px;}
  .attach-req.required{background:rgba(79,142,247,.15);color:var(--accent);}
  .attach-req.optional{background:var(--surface);color:var(--muted);border:1px solid var(--border);}
  .attach-chk input{accent-color:var(--accent);}
  .attach-path{font-family:'JetBrains Mono',monospace;font-size:10px;width:160px;background:var(--bg);border:1px solid var(--border);border-radius:3px;padding:3px 6px;color:var(--text);}

  /* SUBMIT BTN */
  .wf-submit-btn{width:100%;background:var(--accent);color:#fff;border:none;border-radius:4px;padding:9px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all .12s;margin-top:4px;}
  .wf-submit-btn:hover{background:#6fa3fa;}
  .wf-submit-btn:disabled{background:var(--surface2);color:var(--muted);cursor:not-allowed;}

  /* HISTORY */
  .hist-divider{border:none;border-top:1px solid var(--border);margin:18px 0 14px;}
  .hist-row{display:flex;align-items:flex-start;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);font-size:11px;}
  .hist-row:last-child{border-bottom:none;}
  .hist-dot{width:8px;height:8px;border-radius:50%;margin-top:3px;flex-shrink:0;}
  .hist-dot.approved{background:var(--success);}
  .hist-dot.rejected{background:var(--danger);}
  .hist-dot.submitted{background:var(--accent);}
  .hist-body{flex:1;}
  .hist-act{color:var(--text);font-weight:500;}
  .hist-who{color:var(--muted);margin-top:2px;}

  /* ç‰ˆåˆ¥ã‚°ãƒ«ãƒ¼ãƒ— */
  .hist-group{border:1px solid var(--border);border-radius:6px;margin-bottom:8px;overflow:hidden;}
  .hist-group-header{display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;background:var(--surface2);font-size:12px;user-select:none;transition:background .12s;}
  .hist-group-header:hover{background:#2a2f48;}
  .hist-ver{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;color:var(--text);}
  .hist-toggle-icon{font-size:10px;color:var(--muted);margin-left:4px;}
  .hist-group-body{max-height:0;overflow:hidden;transition:max-height .25s ease;padding:0 12px;}
  .hist-group-body.open{max-height:400px;padding:4px 12px 8px;}
  /* æ‰¿èªå±¥æ­´å†…ã®ç”³è«‹å†…å®¹è¡¨ç¤º */
  .hist-form-detail{margin-top:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:8px;overflow-y:auto;max-height:200px;}
  .hist-form-row{display:flex;gap:8px;padding:3px 0;border-bottom:1px solid var(--border);font-size:11px;}
  .hist-form-row:last-child{border-bottom:none;}
  .hist-form-key{color:var(--muted);min-width:120px;flex-shrink:0;}
  .hist-form-val{color:var(--text);}
  /* wf-status inline (å±¥æ­´ãƒãƒƒã‚¸ç”¨) */
  .wf-status.s-approved{background:rgba(34,201,122,.15);color:var(--success);}
  .wf-status.s-rejected{background:rgba(239,68,68,.15);color:var(--danger);}
  .wf-status.s-progress{background:rgba(79,142,247,.15);color:var(--accent);}

  /* WFçµŒè·¯å…¥åŠ›ãƒ†ãƒ¼ãƒ–ãƒ« */
  .wf-route-table{display:flex;flex-direction:column;gap:0;background:var(--surface2);border:1px solid var(--border);border-radius:6px;overflow:hidden;margin-bottom:14px;}
  .wf-rt-row{display:flex;align-items:center;gap:10px;padding:7px 12px;border-bottom:1px solid var(--border);}
  .wf-rt-row:last-child{border-bottom:none;}
  .wf-rt-role{font-size:11px;font-weight:700;min-width:90px;color:var(--muted);}
  .wf-rt-role.applicant-role{color:var(--accent);}
  .wf-rt-role.current-role{color:#f97316;}
  .wf-rt-role.muted-role{color:var(--muted);opacity:.6;}
  .wf-rt-input{flex:1;font-size:12px;}
  .wf-rt-role-input{max-width:100px;}
  .wf-rt-arrow{text-align:center;color:var(--border);font-size:11px;padding:2px 0 2px 12px;}
  .wf-rt-del{background:transparent;border:1px solid var(--border);border-radius:3px;color:var(--muted);font-size:11px;cursor:pointer;padding:2px 6px;flex-shrink:0;transition:all .12s;}
  .wf-rt-del:hover{border-color:var(--danger);color:var(--danger);}
  .wf-add-btn{width:100%;background:transparent;border:1px dashed var(--border);border-radius:4px;color:var(--muted);padding:6px;font-size:11px;cursor:pointer;transition:all .12s;font-family:'Noto Sans JP',sans-serif;margin-bottom:4px;}
  .wf-add-btn:hover{border-color:var(--accent);color:var(--accent);}
  /* é€šçŸ¥ãƒ†ãƒ¼ãƒ–ãƒ« */
  .wf-notify-table{display:flex;flex-direction:column;gap:6px;margin-bottom:6px;}
  .wf-notify-row{display:flex;align-items:center;gap:8px;}
  .wf-notify-icon{font-size:14px;flex-shrink:0;}

  /* æ‰¿èªå±¥æ­´ã®çµŒè·¯è¡¨ç¤º */
  .hist-route{margin-top:8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;overflow:hidden;}
  .hist-route-row{display:grid;grid-template-columns:90px 1fr 1fr 60px;align-items:center;gap:6px;padding:5px 10px;border-bottom:1px solid var(--border);font-size:11px;}
  .hist-route-row:last-child{border-bottom:none;}
  .hist-route-role{font-weight:700;color:var(--muted);}
  .hist-route-role.applicant-role{color:var(--accent);}
  .hist-route-person{color:var(--text);}
  .hist-route-date{color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:10px;}
  .hist-route-status{text-align:center;font-size:10px;font-weight:700;padding:1px 5px;border-radius:8px;}
  .s-approved{background:rgba(34,201,122,.15);color:var(--success);}
  .s-rejected{background:rgba(239,68,68,.15);color:var(--danger);}
  .s-progress{background:rgba(79,142,247,.15);color:var(--accent);}
  .s-wait{background:var(--surface2);color:var(--muted);border:1px solid var(--border);}

  /* TOAST */
  .toast{position:fixed;bottom:20px;right:20px;background:var(--success);color:#fff;padding:9px 16px;border-radius:6px;font-size:12px;font-weight:700;transform:translateY(60px);opacity:0;transition:all .25s;z-index:999;}
  .toast.show{transform:none;opacity:1;}

  /* WFç”³è«‹ãƒœã‚¿ãƒ³ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãƒˆãƒªã‚¬ãƒ¼ï¼‰ */
  .wf-apply-trigger{width:100%;background:var(--accent);color:#fff;border:none;border-radius:6px;padding:10px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:14px;flex-shrink:0;}
  .wf-apply-trigger:hover{background:#6fa3fa;}
  .wf-apply-trigger.open{background:var(--surface2);color:var(--muted);border:1px solid var(--border);}

  /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æœ¬ä½“ */
  .wf-form-accordion{overflow:hidden;transition:max-height .3s ease;max-height:0;}
  .wf-form-accordion.open{max-height:2000px;}

  /* WFçµŒè·¯ãƒ•ãƒ­ãƒ¼ */
  .wf-route{display:flex;align-items:center;gap:0;flex-wrap:wrap;padding:10px 0 6px;overflow-x:auto;}
  .wf-step{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:64px;}
  .wf-step-circle{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;border:2px solid;}
  .wf-step-circle.applicant{background:rgba(79,142,247,.15);border-color:var(--accent);color:var(--accent);}
  .wf-step-circle.approver {background:rgba(34,201,122,.12);border-color:var(--success);color:var(--success);}
  .wf-step-circle.verifier {background:rgba(251,191,36,.12);border-color:var(--warn);color:var(--warn);}
  .wf-step-circle.done     {background:rgba(34,201,122,.25);border-color:var(--success);color:var(--success);}
  .wf-step-circle.current  {background:rgba(79,142,247,.25);border-color:var(--accent);color:#fff;box-shadow:0 0 0 3px rgba(79,142,247,.25);}
  .wf-step-circle.current-worker{background:rgba(249,115,22,.2);border-color:#f97316;color:#f97316;box-shadow:0 0 0 3px rgba(249,115,22,.2);}
  .wf-step-circle.waiting  {background:var(--surface2);border-color:var(--border);color:var(--muted);}
  .wf-step-label{font-size:10px;color:var(--muted);text-align:center;line-height:1.3;white-space:nowrap;}
  .wf-step-label.current{color:var(--accent);}
  .wf-arrow{color:var(--border);font-size:14px;margin:0 2px;margin-bottom:14px;flex-shrink:0;}
  .wf-arrow.done-arrow{color:var(--success);}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <a class="home-btn" href="index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a>
  <div class="header-title">æˆæœç‰©ä¸€è¦§ç®¡ç†</div>
  <div class="pj-badge">PJ-2024-087</div>
  <div class="pj-badge" style="color:var(--text)">è‡ªå‹•æ¬é€ã‚·ã‚¹ãƒ†ãƒ  æ›´æ–°</div>
  <span class="type-tag type-info">æƒ…å ±ç³»</span>
  <span class="type-tag type-ctrl">åˆ¶å¾¡ç³»</span>
  <button class="save-btn" onclick="saveAll()">ğŸ’¾ ä¿å­˜</button>
</div>

<div class="layout">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-label">å·¥ç¨‹</div>
    <div id="phase-list"></div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="toolbar">
      <div class="filter-group">
        <span class="filter-label">ç³»</span>
        <button class="filter-btn active" onclick="setFilter('sys','all',this)">å…¨ã¦</button>
        <button class="filter-btn" onclick="setFilter('sys','æƒ…å ±ç³»',this)">æƒ…å ±ç³»</button>
        <button class="filter-btn" onclick="setFilter('sys','åˆ¶å¾¡ç³»',this)">åˆ¶å¾¡ç³»</button>
      </div>
      <div class="divider"></div>
      <div class="filter-group">
        <span class="filter-label">åŒºåˆ†</span>
        <button class="filter-btn active" onclick="setFilter('req','all',this)">å…¨ã¦</button>
        <button class="filter-btn" onclick="setFilter('req','å¿…é ˆ',this)">å¿…é ˆ</button>
        <button class="filter-btn" onclick="setFilter('req','ä»»æ„',this)">ä»»æ„</button>
      </div>
      <div class="divider"></div>
      <div class="filter-group">
        <span class="filter-label">çŠ¶æ…‹</span>
        <button class="filter-btn active" onclick="setFilter('state','all',this)">å…¨ã¦</button>
        <button class="filter-btn" onclick="setFilter('state','æœªç€æ‰‹',this)">æœªç€æ‰‹</button>
        <button class="filter-btn" onclick="setFilter('state','ä½œæˆä¸­',this)">ä½œæˆä¸­</button>
        <button class="filter-btn" onclick="setFilter('state','ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¸­',this)">WFä¸­</button>
      </div>
      <div class="divider"></div>
      <button class="filter-btn" id="btn-selected" onclick="toggleSelFilter(this)">âœ… é¸æŠæ¸ˆ</button>
      <input class="search-input" type="text" placeholder="ğŸ” æ›¸é¡åæ¤œç´¢..." oninput="render()" id="search">
      <div class="stats" id="stats"></div>
      <button class="add-btn" onclick="addNewRow()">ï¼‹ è¿½åŠ </button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:34px">é¸æŠ</th>
            <th>æ›¸é¡/ãƒ‡ãƒ¼ã‚¿å</th>
            <th style="width:52px">åŒºåˆ†</th>
            <th style="width:52px">å¯¾è±¡ç³»</th>
            <th style="width:30px">å…±æœ‰</th>
            <th style="width:72px">æœ€æ–°ç‰ˆ</th>
            <th style="width:100px">çŠ¶æ…‹</th>
            <th style="width:90px">ç¾ä½œæ¥­è€…</th>
            <th>ä¿ç®¡ãƒ‘ã‚¹</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="summary-bar">
      <div class="summary-item">é¸æŠæ¸ˆ: <span class="sc c-accent" id="cnt-sel">0</span></div>
      <div class="summary-item">å¿…é ˆ: <span class="sc c-success" id="cnt-req">0</span></div>
      <div class="summary-item">ä»»æ„: <span class="sc c-warn" id="cnt-opt">0</span></div>
      <div class="summary-item">åˆè¨ˆ: <span class="sc" id="cnt-all">0</span></div>
      <div class="progress-wrap"><div class="progress-bar" id="prog"></div></div>
    </div>
  </div>

  <!-- DETAIL PANEL -->
  <div class="detail-panel hidden" id="detail-panel">
    <div class="detail-header">
      <span style="font-size:13px;font-weight:700;color:var(--accent)">ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼</span>
      <span class="detail-title" id="detail-title" style="font-size:11px;color:var(--muted);margin-left:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1"></span>
      <button class="detail-close" onclick="closeDetail()">âœ•</button>
    </div>
    <div class="wf-body" id="wf-body"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const PJ_CODE = 'PJ-2024-087';

const PHASES = [
  {code:'A',name:'åŸºæœ¬è¨­è¨ˆ'},{code:'B',name:'æ¦‚è¦è¨­è¨ˆ'},{code:'C',name:'è©³ç´°è¨­è¨ˆ'},
  {code:'D',name:'ãƒ—ãƒ­ã‚°ãƒ©ãƒ é–‹ç™º'},{code:'E',name:'ç¤¾å†…ãƒ†ã‚¹ãƒˆ'},{code:'F',name:'ç¾åœ°ãƒ†ã‚¹ãƒˆ'},
  {code:'G',name:'ç¨¼åƒç«‹ã¡ä¼šã„'},{code:'H',name:'ç®¡ç†'},
];

// state: 'æœªç€æ‰‹' | 'ä½œæˆä¸­' | 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¸­'
// wfStatus: 'none' | 'approved' | 'in-progress' | 'rejected'
let deliverables = [
  {id:1,phase:'A',name:'ç¢ºå®šä»•æ§˜æ›¸',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:true,path:'PJã‚³ãƒ¼ãƒ‰\\02_åŸºæœ¬è¨­è¨ˆ\\01_å—é ˜è³‡æ–™\\02_ç¢ºå®šä»•æ§˜æ›¸',sel:true,deprecated:false,
   ver:'v3',verStatus:'latest',state:'æœªç€æ‰‹',worker:'',wfStatus:'approved',
   history:[
     {act:'WFç”³è«‹',who:'Aã•ã‚“',date:'2024-11-01',datetime:'09:32',type:'submitted',
      route:[{role:'ç”³è«‹è€…',person:'Aã•ã‚“',approvedAt:'2024-11-01 09:32'},{role:'å§”è¨—å…ˆãƒªãƒ¼ãƒ€',person:'Bã•ã‚“',approvedAt:'2024-11-01 14:05'},{role:'PL',person:'Cã•ã‚“',approvedAt:'2024-11-01 16:48'},{role:'æ¤œè¨¼',person:'Dã•ã‚“',approvedAt:'2024-11-02 10:22'},{role:'PM',person:'Eã•ã‚“',approvedAt:'2024-11-02 11:00'}],
      form:{'è¨€èª':'æ—¥æœ¬èª','å›³æ›¸ç•ªå·':'TB-2024-001','åŸºæº–å€¤ï¼ˆç›®æ¨™å€¤ï¼‰':'èª¤å­—è„±å­—0ä»¶','ä½œæˆæ—¥':'2024-11-01','ç”³è«‹å›æ•°':'1å›','è¨ˆç”»æ™‚ã®æ¤œè¨¼äºˆå®šæ—¥':'2024-11-02','æ¤œè¨¼ç¯„å›²':'å…¨ãƒšãƒ¼ã‚¸','æ¤œè¨¼å®Œäº†å¸Œæœ›æ—¥':'2024-11-03','å®Œäº†å¸Œæœ›æ™‚åˆ»':'17:00','ä½œæˆæ‹…å½“è€…':'ç”°ä¸­','ãƒšãƒ¼ã‚¸æ•°':'42','æ¤œè¨¼æ™‚é–“':'2.0h','ä¸å…·åˆä»¶æ•°':'0','æ¨™æº–ä¸å…·åˆä»¶æ•°':'0','æ›¸é¡æ¤œè¨¼å®Ÿæ–½æ¡ä»¶':'â€”'}},
     {act:'PMæ‰¿èª',who:'Eã•ã‚“',date:'2024-11-02',datetime:'11:00',type:'approved'},
     {act:'æ”¹ç‰ˆ v2 ç”³è«‹',who:'Aã•ã‚“',date:'2025-01-10',datetime:'10:15',type:'submitted',
      route:[{role:'ç”³è«‹è€…',person:'Aã•ã‚“',approvedAt:'2025-01-10 10:15'},{role:'å§”è¨—å…ˆãƒªãƒ¼ãƒ€',person:'Bã•ã‚“',approvedAt:'2025-01-10 15:30'},{role:'PL',person:'Cã•ã‚“',approvedAt:'2025-01-11 09:00'},{role:'æ¤œè¨¼',person:'Dã•ã‚“',approvedAt:'2025-01-11 13:45'},{role:'PM',person:'Eã•ã‚“',approvedAt:'2025-01-11 14:20'}],
      form:{'è¨€èª':'æ—¥æœ¬èª','å›³æ›¸ç•ªå·':'TB-2024-001','åŸºæº–å€¤ï¼ˆç›®æ¨™å€¤ï¼‰':'èª¤å­—è„±å­—0ä»¶','ä½œæˆæ—¥':'2025-01-10','ç”³è«‹å›æ•°':'2å›','è¨ˆç”»æ™‚ã®æ¤œè¨¼äºˆå®šæ—¥':'2025-01-11','æ¤œè¨¼ç¯„å›²':'å¤‰æ›´ç®‡æ‰€ï¼ˆp.12-15ï¼‰','æ¤œè¨¼å®Œäº†å¸Œæœ›æ—¥':'2025-01-12','å®Œäº†å¸Œæœ›æ™‚åˆ»':'17:00','ä½œæˆæ‹…å½“è€…':'ç”°ä¸­','ãƒšãƒ¼ã‚¸æ•°':'44','æ¤œè¨¼æ™‚é–“':'1.0h','ä¸å…·åˆä»¶æ•°':'1','æ¨™æº–ä¸å…·åˆä»¶æ•°':'1','æ›¸é¡æ¤œè¨¼å®Ÿæ–½æ¡ä»¶':'â€”'}},
     {act:'PMæ‰¿èª',who:'Eã•ã‚“',date:'2025-01-11',datetime:'14:20',type:'approved'},
     {act:'æ”¹ç‰ˆ v3 ç”³è«‹',who:'Aã•ã‚“',date:'2025-03-05',datetime:'09:50',type:'submitted',
      route:[{role:'ç”³è«‹è€…',person:'Aã•ã‚“',approvedAt:'2025-03-05 09:50'},{role:'å§”è¨—å…ˆãƒªãƒ¼ãƒ€',person:'Bã•ã‚“',approvedAt:'2025-03-05 13:00'},{role:'PL',person:'Cã•ã‚“',approvedAt:'2025-03-05 17:10'},{role:'æ¤œè¨¼',person:'Dã•ã‚“',approvedAt:'2025-03-06 10:05'},{role:'PM',person:'Eã•ã‚“',approvedAt:'2025-03-06 11:30'}],
      form:{'è¨€èª':'æ—¥æœ¬èª','å›³æ›¸ç•ªå·':'TB-2024-001','åŸºæº–å€¤ï¼ˆç›®æ¨™å€¤ï¼‰':'èª¤å­—è„±å­—0ä»¶','ä½œæˆæ—¥':'2025-03-05','ç”³è«‹å›æ•°':'3å›','è¨ˆç”»æ™‚ã®æ¤œè¨¼äºˆå®šæ—¥':'2025-03-06','æ¤œè¨¼ç¯„å›²':'å…¨ãƒšãƒ¼ã‚¸å†æ¤œè¨¼','æ¤œè¨¼å®Œäº†å¸Œæœ›æ—¥':'2025-03-07','å®Œäº†å¸Œæœ›æ™‚åˆ»':'18:00','ä½œæˆæ‹…å½“è€…':'ç”°ä¸­','ãƒšãƒ¼ã‚¸æ•°':'46','æ¤œè¨¼æ™‚é–“':'2.5h','ä¸å…·åˆä»¶æ•°':'0','æ¨™æº–ä¸å…·åˆä»¶æ•°':'0','æ›¸é¡æ¤œè¨¼å®Ÿæ–½æ¡ä»¶':'â€”'}},
     {act:'PMæ‰¿èª',who:'Eã•ã‚“',date:'2025-03-06',datetime:'11:30',type:'approved'},
   ]},
  {id:2,phase:'A',name:'è£½ä½œå¾¡ç¢ºèªä»•æ§˜æ›¸',req:'å¿…é ˆ',sys:'æƒ…å ±ç³»',share:true,path:'PJã‚³ãƒ¼ãƒ‰\\02_åŸºæœ¬è¨­è¨ˆ\\02_è£½ä½œå¾¡ç¢ºèªä»•æ§˜æ›¸',sel:true,deprecated:false,
   ver:'v2',verStatus:'latest',state:'ä½œæˆä¸­',worker:'å±±ç”°',wfStatus:'approved',
   history:[{act:'WFç”³è«‹',who:'ç”°ä¸­PL',date:'2024-11-05',type:'submitted'},{act:'PMæ‰¿èª',who:'éˆ´æœ¨PM',date:'2024-11-06',type:'approved'},{act:'æ”¹ç‰ˆ v2 ç”³è«‹',who:'ç”°ä¸­PL',date:'2025-02-20',type:'submitted'},{act:'PMæ‰¿èª',who:'éˆ´æœ¨PM',date:'2025-02-21',type:'approved'}]},
  {id:3,phase:'A',name:'æ›¸é¡æ¤œè¨¼ä¾é ¼æ›¸',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\05_å“è³ªè¨˜éŒ²\\01_ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ',sel:true,deprecated:false,
   ver:'v1',verStatus:'latest',state:'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¸­',worker:'ç”°ä¸­',wfStatus:'in-progress',
   history:[{act:'WFç”³è«‹',who:'ç”°ä¸­PL',date:'2025-02-18',type:'submitted'}]},
  {id:4,phase:'A',name:'æ›¸é¡æ¤œè¨¼å ±å‘Šæ›¸',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\05_å“è³ªè¨˜éŒ²\\01_ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ',sel:true,deprecated:false,
   ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:5,phase:'A',name:'æ©Ÿå™¨è¨­ç½®åŸºæº–æ›¸',req:'å¿…é ˆ',sys:'åˆ¶å¾¡ç³»',share:true,path:'PJã‚³ãƒ¼ãƒ‰\\02_åŸºæœ¬è¨­è¨ˆ\\03_æ©Ÿå™¨è¨­ç½®åŸºæº–æ›¸',sel:true,deprecated:false,
   ver:'v1',verStatus:'outdated',state:'ä½œæˆä¸­',worker:'ä½è—¤',wfStatus:'rejected',
   history:[{act:'WFç”³è«‹',who:'ç”°ä¸­PL',date:'2025-01-15',type:'submitted'},{act:'å·®ã—æˆ»ã—',who:'éˆ´æœ¨PM',date:'2025-01-16',type:'rejected'}]},
  {id:6,phase:'A',name:'å…¥å‡ºåŠ›æ¥ç¶šä»•æ§˜æ›¸',req:'ä»»æ„',sys:'åˆ¶å¾¡ç³»',share:true,path:'PJã‚³ãƒ¼ãƒ‰\\02_åŸºæœ¬è¨­è¨ˆ\\04_å…¥å‡ºåŠ›æ¥ç¶šä»•æ§˜æ›¸',sel:false,deprecated:false,
   ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:7,phase:'A',name:'ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ‹ãƒ¥ã‚¢ãƒ«',req:'å¿…é ˆ',sys:'æƒ…å ±ç³»',share:true,path:'PJã‚³ãƒ¼ãƒ‰\\02_åŸºæœ¬è¨­è¨ˆ\\05_ã‚ªãƒšãƒãƒ‹',sel:true,deprecated:false,
   ver:'v2',verStatus:'latest',state:'æœªç€æ‰‹',worker:'',wfStatus:'approved',
   history:[{act:'WFç”³è«‹',who:'å±±ç”°æ‹…å½“',date:'2024-12-01',type:'submitted'},{act:'PMæ‰¿èª',who:'éˆ´æœ¨PM',date:'2024-12-02',type:'approved'},{act:'æ”¹ç‰ˆ v2 ç”³è«‹',who:'å±±ç”°æ‹…å½“',date:'2025-03-01',type:'submitted'},{act:'PMæ‰¿èª',who:'éˆ´æœ¨PM',date:'2025-03-02',type:'approved'}]},
  {id:8,phase:'A',name:'é€šä¿¡ä»•æ§˜æ›¸',req:'ä»»æ„',sys:'åˆ¶å¾¡ç³»',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\02_åŸºæœ¬è¨­è¨ˆ\\06_é€šä¿¡ä»•æ§˜',sel:false,deprecated:false,
   ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:9,phase:'A',name:'QAã‚·ãƒ¼ãƒˆ',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\01_è¦ä»¶ç®¡ç†\\03_QAã‚·ãƒ¼ãƒˆ',sel:true,deprecated:false,
   ver:'v1',verStatus:'latest',state:'æœªç€æ‰‹',worker:'',wfStatus:'approved',
   history:[{act:'WFç”³è«‹',who:'ç”°ä¸­PL',date:'2024-11-20',type:'submitted'},{act:'PMæ‰¿èª',who:'éˆ´æœ¨PM',date:'2024-11-21',type:'approved'}]},
  {id:10,phase:'A',name:'åŸºæœ¬è¨­è¨ˆ_ãƒ¬ãƒ“ãƒ¥ãƒ¼å ±å‘Š',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\05_å“è³ªè¨˜éŒ²\\02_ãƒ¬ãƒ“ãƒ¥ãƒ¼å ±å‘Šæ›¸',sel:true,deprecated:false,
   ver:'v1',verStatus:'latest',state:'æœªç€æ‰‹',worker:'',wfStatus:'approved',
   history:[{act:'WFç”³è«‹',who:'ç”°ä¸­PL',date:'2024-11-25',type:'submitted'},{act:'PMæ‰¿èª',who:'éˆ´æœ¨PM',date:'2024-11-26',type:'approved'}]},
  // B
  {id:11,phase:'B',name:'ãƒ†ãƒ¼ãƒ–ãƒ«å€¤å®šç¾©æ›¸',req:'ä»»æ„',sys:'æƒ…å ±ç³»',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\03_ãƒ—ãƒ­ã‚°ãƒ©ãƒ è¨­è¨ˆ\\01_ãƒ†ãƒ¼ãƒ–ãƒ«å€¤å®šç¾©æ›¸',sel:false,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:12,phase:'B',name:'ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šæ›¸',req:'ä»»æ„',sys:'æƒ…å ±ç³»',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\03_ãƒ—ãƒ­ã‚°ãƒ©ãƒ è¨­è¨ˆ\\02_ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šæ›¸',sel:false,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:13,phase:'B',name:'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»å›³',req:'ä»»æ„',sys:'åˆ¶å¾¡ç³»',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\03_ãƒ—ãƒ­ã‚°ãƒ©ãƒ è¨­è¨ˆ\\03_ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»å›³',sel:false,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:14,phase:'B',name:'æ¦‚è¦è¨­è¨ˆ_ãƒ¬ãƒ“ãƒ¥ãƒ¼å ±å‘Š',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\05_å“è³ªè¨˜éŒ²\\02_ãƒ¬ãƒ“ãƒ¥ãƒ¼å ±å‘Šæ›¸',sel:true,deprecated:false,ver:'v1',verStatus:'latest',state:'æœªç€æ‰‹',worker:'',wfStatus:'approved',
   history:[{act:'WFç”³è«‹',who:'ç”°ä¸­PL',date:'2024-12-10',type:'submitted'},{act:'PMæ‰¿èª',who:'éˆ´æœ¨PM',date:'2024-12-11',type:'approved'}]},
  // E
  {id:15,phase:'E',name:'ãƒªãƒ³ã‚¯ãƒ†ã‚¹ãƒˆé …ç›®ä¸€è¦§è¡¨',req:'ä»»æ„',sys:'åˆ¶å¾¡ç³»',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\04_ãƒ†ã‚¹ãƒˆ\\01_ãƒªãƒ³ã‚¯ãƒ†ã‚¹ãƒˆ',sel:false,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:16,phase:'E',name:'ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ',req:'å¿…é ˆ',sys:'æƒ…å ±ç³»',share:true,path:'PJã‚³ãƒ¼ãƒ‰\\04_ãƒ†ã‚¹ãƒˆ\\02_ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ',sel:true,deprecated:false,ver:'v1',verStatus:'latest',state:'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¸­',worker:'å±±ç”°',wfStatus:'in-progress',
   history:[{act:'WFç”³è«‹',who:'å±±ç”°æ‹…å½“',date:'2025-02-15',type:'submitted'}]},
  {id:17,phase:'E',name:'æ¤œè¨¼ä¾é ¼æ›¸',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\05_å“è³ªè¨˜éŒ²\\03_ãƒ—ãƒ­ã‚°ãƒ©ãƒ æ¤œè¨¼',sel:true,deprecated:false,ver:'v1',verStatus:'latest',state:'æœªç€æ‰‹',worker:'',wfStatus:'approved',
   history:[{act:'WFç”³è«‹',who:'ç”°ä¸­PL',date:'2025-01-20',type:'submitted'},{act:'PMæ‰¿èª',who:'éˆ´æœ¨PM',date:'2025-01-21',type:'approved'}]},
  {id:18,phase:'E',name:'æ¤œè¨¼å ±å‘Šæ›¸',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\05_å“è³ªè¨˜éŒ²\\03_ãƒ—ãƒ­ã‚°ãƒ©ãƒ æ¤œè¨¼',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:19,phase:'E',name:'å‡ºè·æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\04_ãƒ†ã‚¹ãƒˆ\\03_å‡ºè·æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:20,phase:'E',name:'æ¤œè¨¼_ä¸å…·åˆç®¡ç†è¡¨',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\05_å“è³ªè¨˜éŒ²\\03_ãƒ—ãƒ­ã‚°ãƒ©ãƒ æ¤œè¨¼',sel:true,deprecated:false,ver:'v1',verStatus:'latest',state:'æœªç€æ‰‹',worker:'',wfStatus:'approved',
   history:[{act:'WFç”³è«‹',who:'ç”°ä¸­PL',date:'2025-01-22',type:'submitted'},{act:'PMæ‰¿èª',who:'éˆ´æœ¨PM',date:'2025-01-23',type:'approved'}]},
  {id:21,phase:'E',name:'ã‚¦ã‚¤ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿæ–½å ±å‘Šæ›¸',req:'å¿…é ˆ',sys:'æƒ…å ±ç³»',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\04_ãƒ†ã‚¹ãƒˆ\\05_ã‚¦ã‚¤ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿæ–½å ±å‘Šæ›¸',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  // F
  {id:22,phase:'F',name:'ç¾åœ°ãƒ†ã‚¹ãƒˆè¨ˆç”»æ›¸',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\05_ç¾åœ°èª¿æ•´\\01_ç¾åœ°ãƒ†ã‚¹ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:23,phase:'F',name:'ä½œæ¥­æ‰‹é †æ›¸',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\05_ç¾åœ°èª¿æ•´\\01_ç¾åœ°ãƒ†ã‚¹ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:24,phase:'F',name:'å®‰å…¨ä½œæ¥­å ±å‘Šæ›¸',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\05_ç¾åœ°èª¿æ•´\\02_å®‰å…¨ä½œæ¥­å ±å‘Šæ›¸',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:25,phase:'F',name:'ç¾åœ°èª¿æ•´å ±å‘Šæ›¸',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\05_ç¾åœ°èª¿æ•´\\03_ç¾åœ°èª¿æ•´å ±å‘Šæ›¸',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:26,phase:'F',name:'ç¾åœ°èª¿æ•´_ä¸å…·åˆç®¡ç†è¡¨',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\05_ç¾åœ°èª¿æ•´\\03_ç¾åœ°èª¿æ•´å ±å‘Šæ›¸',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:27,phase:'F',name:'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †æ›¸',req:'å¿…é ˆ',sys:'æƒ…å ±ç³»',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\05_ç¾åœ°èª¿æ•´\\10_ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †æ›¸',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  // H
  {id:28,phase:'H',name:'è¦‹ç©ä¾é ¼æ›¸',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\01_è¨ˆç”»\\05_ä¾›çµ¦è€…åˆæ„ç®¡ç†',sel:true,deprecated:false,ver:'v1',verStatus:'latest',state:'æœªç€æ‰‹',worker:'',wfStatus:'approved',
   history:[{act:'WFç”³è«‹',who:'ç”°ä¸­PL',date:'2024-10-10',type:'submitted'},{act:'PMæ‰¿èª',who:'éˆ´æœ¨PM',date:'2024-10-11',type:'approved'}]},
  {id:29,phase:'H',name:'ç™ºæ³¨ä¾é ¼æ›¸',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\01_è¨ˆç”»\\05_ä¾›çµ¦è€…åˆæ„ç®¡ç†',sel:true,deprecated:false,ver:'v1',verStatus:'latest',state:'æœªç€æ‰‹',worker:'',wfStatus:'approved',
   history:[{act:'WFç”³è«‹',who:'ç”°ä¸­PL',date:'2024-10-15',type:'submitted'},{act:'PMæ‰¿èª',who:'éˆ´æœ¨PM',date:'2024-10-16',type:'approved'}]},
  {id:30,phase:'H',name:'ãƒªã‚¹ã‚¯ç®¡ç†è¡¨',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\02_ãƒªã‚¹ã‚¯ç®¡ç†',sel:true,deprecated:false,ver:'v2',verStatus:'latest',state:'æœªç€æ‰‹',worker:'',wfStatus:'approved',
   history:[{act:'WFç”³è«‹',who:'ç”°ä¸­PL',date:'2024-10-20',type:'submitted'},{act:'PMæ‰¿èª',who:'éˆ´æœ¨PM',date:'2024-10-21',type:'approved'},{act:'æ”¹ç‰ˆ v2 ç”³è«‹',who:'ç”°ä¸­PL',date:'2025-01-05',type:'submitted'},{act:'PMæ‰¿èª',who:'éˆ´æœ¨PM',date:'2025-01-06',type:'approved'}]},
  {id:31,phase:'H',name:'èª²é¡Œç®¡ç†è¡¨',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\03_èª²é¡Œç®¡ç†è¡¨',sel:true,deprecated:false,ver:'v1',verStatus:'latest',state:'æœªç€æ‰‹',worker:'',wfStatus:'approved',
   history:[{act:'WFç”³è«‹',who:'ç”°ä¸­PL',date:'2024-10-25',type:'submitted'},{act:'PMæ‰¿èª',who:'éˆ´æœ¨PM',date:'2024-10-26',type:'approved'}]},
  {id:32,phase:'H',name:'å€Ÿã‚Šå…¥ã‚Œå“ç®¡ç†è¡¨',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\06_è²¸ã—å‡ºã—ãƒ»å€Ÿã‚Šå…¥ã‚Œç®¡ç†',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:33,phase:'H',name:'è²¸ã—å‡ºã—å“ç®¡ç†è¡¨',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\06_è²¸ã—å‡ºã—ãƒ»å€Ÿã‚Šå…¥ã‚Œç®¡ç†',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:34,phase:'H',name:'å®Œäº†ãƒ¬ãƒ“ãƒ¥ãƒ¼å ±å‘Šæ›¸',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\07_å®Œäº†ãƒ¬ãƒ“ãƒ¥ãƒ¼',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:35,phase:'H',name:'å§”è¨—å…ˆè©•ä¾¡è¡¨(ç‰©ä»¶æ¯)',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\09_å§”è¨—å…ˆè©•ä¾¡ï¼ˆç‰©ä»¶æ¯ï¼‰',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:36,phase:'H',name:'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†æ›¸',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:false,path:'PJã‚³ãƒ¼ãƒ‰\\10_ç®¡ç†\\08_ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†æ›¸',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
  {id:37,phase:'H',name:'ä¿å®ˆä¸€è¦§è¡¨',req:'å¿…é ˆ',sys:'ä¸¡æ–¹',share:true,path:'PJã‚³ãƒ¼ãƒ‰\\90_ãã®ä»–\\01_ç´å…¥ç‰©ä»¶æƒ…å ±',sel:true,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]},
];

let filters = {sys:'all',req:'all',state:'all',sel:false};
let activePhase = 'A';
let selectedId = null;
let nextId = 100;

// ---- INIT ----
function init() { renderSidebar(); render(); }

// ---- SIDEBAR ----
function renderSidebar() {
  const el = document.getElementById('phase-list');
  el.innerHTML = PHASES.map(p => {
    const rows = deliverables.filter(d => d.phase===p.code && !d.deprecated);
    const sel = rows.filter(d=>d.sel).length;
    const done = rows.length>0 && sel===rows.length;
    return `<div class="phase-item${activePhase===p.code?' active':''}" onclick="setPhase('${p.code}')">
      <span class="phase-code">${p.code}</span>
      <span class="phase-name">${p.name}</span>
      <span class="phase-badge${done?' all-done':''}">${sel}/${rows.length}</span>
    </div>`;
  }).join('');
}
function setPhase(c){activePhase=c;renderSidebar();render();}

// ---- FILTERS ----
function setFilter(type,val,btn){
  filters[type]=val;
  btn.closest('.filter-group').querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  render();
}
function toggleSelFilter(btn){
  filters.sel=!filters.sel;
  btn.classList.toggle('active',filters.sel);
  render();
}

// ---- RENDER TABLE ----
function render() {
  const q = document.getElementById('search').value.toLowerCase();
  const rows = deliverables.filter(d=>{
    if(d.phase!==activePhase) return false;
    if(filters.sys!=='all' && d.sys!==filters.sys && d.sys!=='ä¸¡æ–¹') return false;
    if(filters.req!=='all' && d.req!==filters.req) return false;
    if(filters.state!=='all' && d.state!==filters.state) return false;
    if(filters.sel && !d.sel) return false;
    if(q && !d.name.toLowerCase().includes(q)) return false;
    return true;
  });

  const tbody = document.getElementById('tbody');
  tbody.innerHTML = rows.map(d=>{
    const path = d.path.replace(/PJã‚³ãƒ¼ãƒ‰/g, PJ_CODE);
    const verHtml = d.verStatus==='latest'
      ? `<span class="ver-badge latest">âœ“ ${d.ver}</span>`
      : d.verStatus==='outdated'
      ? `<span class="ver-badge outdated">âš  ${d.ver}</span>`
      : `<span class="ver-badge">âˆ’</span>`;
    const stateHtml = d.state==='ä½œæˆä¸­'
      ? `<span class="state-badge state-wip">ä½œæˆä¸­</span>`
      : d.state==='ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¸­'
      ? `<span class="state-badge state-wf">WFä¸­</span>`
      : `<span class="state-badge state-none">æœªç€æ‰‹</span>`;
    const isSel = selectedId===d.id;
    return `<tr class="row${d.req==='å¿…é ˆ'?' required':''}${d.deprecated?' deprecated':''}${isSel?' selected-row':''}" onclick="selectRow(${d.id})">
      <td onclick="event.stopPropagation()"><input type="checkbox" ${d.sel?'checked':''} onchange="toggleSel(${d.id})" ${d.deprecated?'disabled':''}></td>
      <td style="font-size:13px;padding:7px 9px">${d.name}</td>
      <td><span class="req-badge ${d.req==='å¿…é ˆ'?'req-required':'req-optional'}">${d.req}</span></td>
      <td>${sysTag(d.sys)}</td>
      <td>${d.share?'<span class="share-icon">ğŸ”—</span>':''}</td>
      <td>${verHtml}</td>
      <td>${stateHtml}</td>
      <td class="worker-cell">${d.worker||'<span style="color:var(--border)">â€”</span>'}</td>
      <td><div class="path-cell" title="${path}">${path}</div></td>
    </tr>`;
  }).join('');

  updateSummary();
  renderSidebar();
}

function sysTag(sys){
  if(sys==='æƒ…å ±ç³»') return '<span class="sys-tag sys-info">æƒ…å ±</span>';
  if(sys==='åˆ¶å¾¡ç³»') return '<span class="sys-tag sys-ctrl">åˆ¶å¾¡</span>';
  return '<span class="sys-tag sys-both">ä¸¡æ–¹</span>';
}

// ---- SUMMARY ----
function updateSummary(){
  const all=deliverables.filter(d=>!d.deprecated);
  const sel=all.filter(d=>d.sel);
  document.getElementById('cnt-all').textContent=all.length;
  document.getElementById('cnt-sel').textContent=sel.length;
  document.getElementById('cnt-req').textContent=sel.filter(d=>d.req==='å¿…é ˆ').length;
  document.getElementById('cnt-opt').textContent=sel.filter(d=>d.req==='ä»»æ„').length;
  const pct=all.length?Math.round(sel.length/all.length*100):0;
  document.getElementById('prog').style.width=pct+'%';
  document.getElementById('stats').innerHTML=`<span>${pct}%</span> é¸æŠ`;
}

// ---- ROW ACTIONS ----
function toggleSel(id){
  const d=deliverables.find(x=>x.id===id);
  if(d){d.sel=!d.sel;updateSummary();renderSidebar();}
}
function addNewRow(){
  deliverables.push({id:nextId++,phase:activePhase,name:'æ–°è¦æˆæœç‰©',req:'ä»»æ„',sys:'ä¸¡æ–¹',share:false,
    path:'PJã‚³ãƒ¼ãƒ‰\\',sel:false,deprecated:false,ver:'-',verStatus:'none',state:'æœªç€æ‰‹',worker:'',wfStatus:'none',history:[]});
  render();
}

// ---- DETAIL PANEL ----
function selectRow(id){
  selectedId = (selectedId===id) ? null : id;
  render();
  if(selectedId===null){closeDetail();return;}
  const d = deliverables.find(x=>x.id===id);
  openDetail(d);
}

function closeDetail(){
  selectedId=null;
  wfFormOpen=false;
  document.getElementById('detail-panel').classList.add('hidden');
  render();
}

function openDetail(d){
  document.getElementById('detail-panel').classList.remove('hidden');
  document.getElementById('detail-title').textContent = d.name;
  renderWFPanel(d);
}

// ---- WF PANEL ----
const TODAY = new Date().toISOString().slice(0,10);

// æ­£ã—ã„WFçµŒè·¯: ç”³è«‹è€… > å§”è¨—å…ˆãƒªãƒ¼ãƒ€ > PL > æ¤œè¨¼ > PM
const WF_ROUTE = [
  {role:'ç”³è«‹è€…',     type:'applicant'},
  {role:'å§”è¨—å…ˆ\nãƒªãƒ¼ãƒ€', type:'approver'},
  {role:'PL',        type:'approver'},
  {role:'æ¤œè¨¼',      type:'verifier'},
  {role:'PM',        type:'approver'},
];

let wfFormOpen = false;
// ç‰ˆã”ã¨ã®é–‹é–‰çŠ¶æ…‹: { 'v1': true, 'v2': false, ... }
let histOpenMap = {};

function renderWFPanel(d){
  const stMap={
    'none':       {label:'æœªç”³è«‹',   cls:'wf-st-none'},
    'in-progress':{label:'ç”³è«‹ä¸­',   cls:'wf-st-progress'},
    'approved':   {label:'æ‰¿èªæ¸ˆ',   cls:'wf-st-approved'},
    'rejected':   {label:'å·®ã—æˆ»ã—', cls:'wf-st-rejected'},
  };
  const st = stMap[d.wfStatus]||stMap['none'];
  const canSubmit = d.wfStatus!=='in-progress';

  // ---- WFçµŒè·¯ãƒ•ãƒ­ãƒ¼ï¼ˆç”³è«‹ãƒ«ãƒ¼ãƒˆè¨­å®šã€‚ç¾ä½œæ¥­è€…=æ¤œè¨¼ã‚’ã‚ªãƒ¬ãƒ³ã‚¸ã€PM=æœªä½œæ¥­ã‚°ãƒ¬ãƒ¼ï¼‰ ----
  // d.workerã‹ã‚‰ç¾åœ¨ã®æ‹…å½“ãƒ­ãƒ¼ãƒ«ã‚’åˆ¤å®šï¼ˆä»®ï¼šworkeråâ†’ãƒ­ãƒ¼ãƒ«å¯¾å¿œï¼‰
  // ä»Šå›ã¯ã€Œæ¤œè¨¼ã€ãŒç¾ä½œæ¥­è€…ã€ã€ŒPMã€ãŒæœªä½œæ¥­ã¨ã—ã¦å›ºå®šè¡¨ç¤º
  const currentStep = 'æ¤œè¨¼'; // æœ¬æ¥ã¯d.wfStatusã‚„d.workerã‹ã‚‰å‹•çš„ã«åˆ¤å®š
  const routeHtml = WF_ROUTE.map((step, i) => {
    const roleName = step.role.replace('\n','');
    let circleClass, labelStyle='';
    if(roleName === currentStep && d.wfStatus === 'in-progress'){
      circleClass = 'current-worker'; // ã‚ªãƒ¬ãƒ³ã‚¸
      labelStyle = 'color:#f97316;font-weight:700';
    } else if(roleName === 'PM' && d.wfStatus === 'in-progress'){
      circleClass = 'waiting'; // ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
      labelStyle = 'color:var(--muted)';
    } else {
      circleClass = 'approver';
    }
    const arrow = i < WF_ROUTE.length-1 ? `<span class="wf-arrow">â€º</span>` : '';
    return `
      <div class="wf-step">
        <div class="wf-step-circle ${circleClass}">${step.role.split('\n')[0]}</div>
        <div class="wf-step-label" style="${labelStyle}">${step.role.replace('\n','<br>')}</div>
      </div>${arrow}`;
  }).join('');

  // ---- æ·»ä»˜è³‡æ–™ ----
  const attachItems = [
    {label:'æ¤œè¨¼å¯¾è±¡ã®æ›¸é¡',        req:'required', def:true},
    {label:'ä¸å…·åˆç®¡ç†è¡¨ï¼ˆæ›¸é¡ï¼‰',   req:'optional', def:false},
    {label:'ä¸å…·åˆç®¡ç†è¡¨ï¼ˆå§”è¨—å…ˆï¼‰', req:'optional', def:false},
    {label:'èª²é¡Œç®¡ç†è¡¨',             req:'optional', def:false},
    {label:'ãã®ä»–ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰',     req:'optional', def:false},
  ];
  const attachHtml = attachItems.map(a=>`
    <div class="attach-row">
      <span class="attach-label">${a.label}</span>
      <span class="attach-req ${a.req}">${a.req==='required'?'æ·»ä»˜å¿…é ˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆâœ“ï¼‰':'æ·»ä»˜ä»»æ„'}</span>
      <label class="attach-chk"><input type="checkbox" ${a.def?'checked':''}></label>
      <input class="attach-path" placeholder="${a.req==='required'?'âœ“ã‚ã‚‹å ´åˆã¯å¿…é ˆ':'âœ“ã‚ã‚‹å ´åˆã«å¿…é ˆ'}"/>
    </div>`).join('');

  // ---- æ‰¿èªå±¥æ­´ã‚’ç‰ˆã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ– ----
  // historyé…åˆ—ã‹ã‚‰ç‰ˆ(v1,v2...)ã‚’åŒºåˆ‡ã‚Šã«ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘
  const groups = [];
  let cur = null;
  for(const h of d.history){
    // ã€Œç”³è«‹ã€ã‚¨ãƒ³ãƒˆãƒªã§æ–°ã‚°ãƒ«ãƒ¼ãƒ—é–‹å§‹
    if(h.type==='submitted'){
      // ç‰ˆç•ªå·ã‚’ç”³è«‹actã‹ã‚‰æŠ½å‡º or ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      const match = h.act.match(/v\d+/);
      const ver = match ? match[0] : (groups.length===0 ? 'v1' : `v${groups.length+1}`);
      cur = {ver, items:[h]};
      groups.push(cur);
    } else {
      if(!cur){ cur={ver:'v1',items:[]}; groups.push(cur); }
      cur.items.push(h);
    }
  }

  const histHtml = groups.length===0
    ? '<div style="color:var(--muted);font-size:12px;padding:16px 0;text-align:center">å±¥æ­´ãªã—</div>'
    : [...groups].reverse().map((g,gi)=>{
        const key = `${d.id}_${g.ver}_${gi}`;
        if(histOpenMap[key]===undefined) histOpenMap[key] = gi===0; // æœ€æ–°ã ã‘é–‹ã
        const isOpen = histOpenMap[key];
        const lastItem = g.items[g.items.length-1];
        const statusCls = lastItem.type==='approved' ? 's-approved'
                        : lastItem.type==='rejected' ? 's-rejected' : 's-progress';
        const statusLabel = lastItem.type==='approved' ? 'æ‰¿èªæ¸ˆ'
                          : lastItem.type==='rejected' ? 'å·®ã—æˆ»ã—' : 'ç”³è«‹ä¸­';
        const rowsHtml = g.items.map(h=>{
          // ç”³è«‹ã‚¨ãƒ³ãƒˆãƒªï¼šç”³è«‹å†…å®¹ + WFçµŒè·¯ãƒ†ãƒ¼ãƒ–ãƒ«
          const formHtml = (h.type==='submitted' && h.form) ? `
            <div class="hist-form-detail">
              ${Object.entries(h.form).map(([k,v])=>`
                <div class="hist-form-row">
                  <span class="hist-form-key">${k}</span>
                  <span class="hist-form-val">${v||'â€”'}</span>
                </div>`).join('')}
            </div>` : '';
          // WFçµŒè·¯ï¼ˆç”³è«‹æ™‚ã«ä¿å­˜ã—ãŸrouteé…åˆ—ã‚’è¡¨ç¤ºï¼‰
          const routeDispHtml = (h.type==='submitted' && h.route) ? `
            <div class="hist-route">
              ${h.route.map((r,ri)=>`
                <div class="hist-route-row">
                  <span class="hist-route-role ${ri===0?'applicant-role':''}">${r.role}</span>
                  <span class="hist-route-person">${r.person}</span>
                  <span class="hist-route-date">${r.approvedAt||'â€”'}</span>
                  <span class="hist-route-status ${r.approvedAt?'s-approved':ri===0?'s-progress':'s-wait'}">${r.approvedAt?'æ‰¿èªæ¸ˆ':ri===0?'ç”³è«‹':'å¾…æ©Ÿ'}</span>
                </div>`).join('')}
            </div>` : '';
          return `
            <div class="hist-row">
              <div class="hist-dot ${h.type}"></div>
              <div class="hist-body">
                <div class="hist-act">${h.act}</div>
                <div class="hist-who">${h.who} ï¼ ${h.date}${h.datetime?' '+h.datetime:''}</div>
                ${h.notify&&h.notify.length ? `<div style="font-size:11px;color:var(--warn);margin-top:2px">ğŸ”” é€šçŸ¥: ${h.notify.join(' / ')}</div>` : ''}
                ${formHtml}
                ${routeDispHtml}
              </div>
            </div>`;
        }).join('');
        return `
          <div class="hist-group">
            <div class="hist-group-header" onclick="toggleHist('${key}',${d.id})">
              <span class="hist-ver">${g.ver}</span>
              <span class="wf-status ${statusCls}" style="font-size:10px;padding:1px 7px;border-radius:10px;font-weight:700">${statusLabel}</span>
              <span style="margin-left:auto;color:var(--muted);font-size:11px">${g.items[0].date}</span>
              <span class="hist-toggle-icon">${isOpen?'â–²':'â–¼'}</span>
            </div>
            <div class="hist-group-body${isOpen?' open':''}">
              ${rowsHtml}
            </div>
          </div>`;
      }).join('');

  const triggerLabel = wfFormOpen ? 'â–² ç”³è«‹å…¥åŠ›ã‚’é–‰ã˜ã‚‹' : 'ğŸ“¤ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”³è«‹';

  document.getElementById('wf-body').innerHTML = `
    <!-- ç¾åœ¨çŠ¶æ…‹ãƒãƒ¼ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåãªã—ï¼‰ -->
    <div class="wf-status-bar" style="margin-bottom:10px">
      <div>
        <div class="wf-cur-ver" style="font-size:12px">ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${d.ver} ï¼ å·¥ç¨‹: ${d.phase}</div>
      </div>
      <span class="wf-status-tag ${st.cls}">${st.label}</span>
    </div>

    <!-- WFç”³è«‹ãƒˆãƒªã‚¬ãƒ¼ãƒœã‚¿ãƒ³ -->
    <button class="wf-apply-trigger ${wfFormOpen?'open':''}"
      onclick="toggleWFForm(${d.id})" ${!canSubmit?'disabled':''}>
      ${!canSubmit ? 'â³ ç”³è«‹ä¸­ï¼ˆç”³è«‹ä¸å¯ï¼‰' : triggerLabel}
    </button>

    <!-- ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼šç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="wf-form-accordion ${wfFormOpen?'open':''}" id="wf-accordion">
      <div style="padding:0 2px 14px">
        <div class="form-grid">
          <div class="field-group">
            <div class="field-label">è¨€èª</div>
            <select class="field-select"><option>æ—¥æœ¬èª</option><option>è‹±èª</option><option>ãã®ä»–</option></select>
          </div>
          <div class="field-group">
            <div class="field-label">å›³æ›¸ç•ªå·</div>
            <input class="field-input" placeholder="å›³æ›¸ç•ªå·">
          </div>
        </div>
        <div class="form-grid">
          <div class="field-group">
            <div class="field-label"><span class="req-mark">*</span>åŸºæº–å€¤ï¼ˆç›®æ¨™å€¤ï¼‰</div>
            <input class="field-input" placeholder="å…¥åŠ›">
          </div>
          <div class="field-group">
            <div class="field-label">ä½œæˆæ—¥</div>
            <input class="field-input" type="date" value="${TODAY}">
          </div>
        </div>
        <div class="form-grid">
          <div class="field-group">
            <div class="field-label">ç”³è«‹å›æ•°</div>
            <select class="field-select"><option>1å›</option><option>2å›</option><option>3å›</option><option>ãã®ä»–</option></select>
          </div>
          <div class="field-group">
            <div class="field-label">è¨ˆç”»æ™‚ã®æ¤œè¨¼äºˆå®šæ—¥</div>
            <input class="field-input" type="date" value="${TODAY}">
          </div>
        </div>
        <div class="form-grid">
          <div class="field-group">
            <div class="field-label"><span class="req-mark">*</span>æ¤œè¨¼ç¯„å›²</div>
            <input class="field-input" placeholder="å…¥åŠ›">
          </div>
          <div class="field-group">
            <div class="field-label">æ¤œè¨¼å®Œäº†å¸Œæœ›æ—¥</div>
            <input class="field-input" type="date" value="${TODAY}">
          </div>
        </div>
        <div class="form-grid">
          <div class="field-group">
            <div class="field-label">å®Œäº†å¸Œæœ›æ™‚åˆ»</div>
            <input class="field-input" type="time">
          </div>
          <div class="field-group">
            <div class="field-label"><span class="req-mark">*</span>ä½œæˆæ‹…å½“è€…</div>
            <input class="field-input" placeholder="æ°å">
          </div>
        </div>
        <div class="form-grid">
          <div class="field-group">
            <div class="field-label"><span class="req-mark">*</span>ãƒšãƒ¼ã‚¸æ•°</div>
            <div class="field-input-row"><input class="field-input" type="number" placeholder="0"><span class="unit">ãƒšãƒ¼ã‚¸</span></div>
          </div>
          <div class="field-group">
            <div class="field-label">æ¤œè¨¼æ™‚é–“</div>
            <select class="field-select">
              <option>0.5h</option><option>1.0h</option><option>1.5h</option><option>2.0h</option>
              <option>2.5h</option><option>3.0h</option><option>4.0h</option><option>5.0h</option><option>ãã®ä»–</option>
            </select>
          </div>
        </div>
        <div class="form-grid">
          <div class="field-group">
            <div class="field-label">ä¸å…·åˆä»¶æ•°</div>
            <div class="field-input-row"><input class="field-input" type="number" placeholder="0"><span class="unit">ä»¶</span></div>
          </div>
          <div class="field-group">
            <div class="field-label">ä¸å…·åˆä»¶æ•°å†…ã®æ¨™æº–ä¸å…·åˆ</div>
            <div class="field-input-row"><input class="field-input" type="number" placeholder="0"><span class="unit">ä»¶</span></div>
          </div>
        </div>
        <div class="form-grid full">
          <div class="field-group">
            <div class="field-label">æ›¸é¡æ¤œè¨¼å®Ÿæ–½æ¡ä»¶</div>
            <select class="field-select"><option>ï¼ˆé¸æŠè‚¢ã‚’ç”¨æ„ï¼‰</option></select>
          </div>
        </div>

        <!-- æ·»ä»˜è³‡æ–™ -->
        <div class="section-title" style="margin-top:8px">æ·»ä»˜è³‡æ–™</div>
        ${attachHtml}

        <!-- WFçµŒè·¯ï¼ˆç”³è«‹ãƒ«ãƒ¼ãƒˆè¨­å®šãƒ»å‹•çš„è¿½åŠ å‰Šé™¤ï¼‰ -->
        <div class="section-title" style="margin-top:14px">WFçµŒè·¯</div>
        <div id="wf-route-container"></div>
        <button class="wf-add-btn" onclick="addRouteStep()">ï¼‹ ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ </button>

        <!-- é€šçŸ¥ -->
        <div class="section-title" style="margin-top:14px">é€šçŸ¥å…ˆ</div>
        <div id="wf-notify-container"></div>
        <button class="wf-add-btn" onclick="addNotifyRow()">ï¼‹ é€šçŸ¥å…ˆã‚’è¿½åŠ </button>

        <button class="wf-submit-btn" style="margin-top:14px" onclick="submitWF(${d.id})">ğŸ“¤ ç”³è«‹ã‚’é€ä¿¡</button>
      </div>
    </div>

    <!-- æ‰¿èªå±¥æ­´ï¼ˆç‰ˆåˆ¥é–‹é–‰ï¼‰ -->
    <hr class="hist-divider">
    <div class="section-title">æ‰¿èªå±¥æ­´</div>
    ${histHtml}
  `;

  // å‹•çš„WFçµŒè·¯ã‚’åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  renderRouteSteps();
  renderNotifyRows();
}

// ---- WFçµŒè·¯ãƒ»é€šçŸ¥ å‹•çš„ç®¡ç† ----
let wfRouteSteps = [
  {role:'ç”³è«‹è€…',     person:'Aã•ã‚“', fixed:true},
  {role:'å§”è¨—å…ˆãƒªãƒ¼ãƒ€',person:'Bã•ã‚“', fixed:false},
  {role:'PL',        person:'Cã•ã‚“', fixed:false},
  {role:'æ¤œè¨¼',      person:'Dã•ã‚“', fixed:false},
  {role:'PM',        person:'Eã•ã‚“', fixed:false},
];
let wfNotifyRows = [
  {person:'Fã•ã‚“'},
  {person:'Gã•ã‚“'},
];

function renderRouteSteps(){
  const c = document.getElementById('wf-route-container');
  if(!c) return;
  c.innerHTML = `<div class="wf-route-table">` +
    wfRouteSteps.map((s,i)=>{
      const isFirst = i===0;
      const arrow = i < wfRouteSteps.length-1
        ? `<div class="wf-rt-arrow">â†“</div>` : '';
      const delBtn = !isFirst
        ? `<button class="wf-rt-del" onclick="removeRouteStep(${i})" title="å‰Šé™¤">âœ•</button>` : '';
      const roleStyle = isFirst ? 'color:var(--accent)' : '';
      return `
        <div class="wf-rt-row" id="rt-row-${i}">
          <input class="field-input wf-rt-input wf-rt-role-input" value="${s.role}"
            placeholder="ãƒ­ãƒ¼ãƒ«å" oninput="wfRouteSteps[${i}].role=this.value"
            ${isFirst?'style="color:var(--accent);font-weight:700"':''}>
          <span style="color:var(--muted);font-size:11px;flex-shrink:0">â†’</span>
          <input class="field-input wf-rt-input" value="${s.person}"
            placeholder="æ‹…å½“è€…å" oninput="wfRouteSteps[${i}].person=this.value">
          ${delBtn}
        </div>
        ${i < wfRouteSteps.length-1 ? '<div class="wf-rt-arrow">â†“</div>' : ''}`;
    }).join('') + `</div>`;
}

function addRouteStep(){
  wfRouteSteps.push({role:'æ‰¿èªè€…',person:'',fixed:false});
  renderRouteSteps();
}

function removeRouteStep(i){
  if(i===0) return; // ç”³è«‹è€…ã¯å‰Šé™¤ä¸å¯
  wfRouteSteps.splice(i,1);
  renderRouteSteps();
}

function renderNotifyRows(){
  const c = document.getElementById('wf-notify-container');
  if(!c) return;
  if(wfNotifyRows.length===0){
    c.innerHTML='<div style="color:var(--muted);font-size:11px;padding:4px 0">é€šçŸ¥å…ˆãªã—</div>';
    return;
  }
  c.innerHTML = `<div class="wf-notify-table">` +
    wfNotifyRows.map((n,i)=>`
      <div class="wf-notify-row">
        <span class="wf-notify-icon">ğŸ””</span>
        <input class="field-input wf-rt-input" value="${n.person}"
          placeholder="é€šçŸ¥å…ˆã®æ°å" oninput="wfNotifyRows[${i}].person=this.value">
        <button class="wf-rt-del" onclick="removeNotifyRow(${i})" title="å‰Šé™¤">âœ•</button>
      </div>`).join('') + `</div>`;
}

function addNotifyRow(){
  wfNotifyRows.push({person:''});
  renderNotifyRows();
}

function removeNotifyRow(i){
  wfNotifyRows.splice(i,1);
  renderNotifyRows();
}

function toggleWFForm(id){
  wfFormOpen = !wfFormOpen;
  const d = deliverables.find(x=>x.id===id);
  renderWFPanel(d);
}

function toggleHist(key, id){
  histOpenMap[key] = !histOpenMap[key];
  const d = deliverables.find(x=>x.id===id);
  renderWFPanel(d);
}

function submitWF(id){
  const d=deliverables.find(x=>x.id===id);
  if(!d||!confirm('ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ')) return;
  d.wfStatus='in-progress';
  d.state='ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¸­';

  // WFçµŒè·¯ã‚’åé›†ï¼ˆæœ€æ–°ã®inputå€¤ã‚’åæ˜ ï¼‰
  const rtRows = document.querySelectorAll('#wf-route-container .wf-rt-row');
  const route = wfRouteSteps.map((s,i)=>({
    role: s.role,
    person: s.person||'â€”',
    approvedAt: i===0 ? `${TODAY} ${new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'})}` : null,
  }));

  // é€šçŸ¥å…ˆåé›†
  const notify = wfNotifyRows.map(n=>n.person).filter(p=>p.trim());

  // ãƒ•ã‚©ãƒ¼ãƒ å€¤åé›†
  const acc = document.querySelector('.wf-form-accordion');
  const selects   = acc ? [...acc.querySelectorAll('.field-select')] : [];
  const inputs    = acc ? [...acc.querySelectorAll('.field-input:not(.wf-rt-input):not(.wf-notify-row .field-input)')] : [];
  const dateInp   = acc ? [...acc.querySelectorAll('input[type=date]')] : [];
  const numInp    = acc ? [...acc.querySelectorAll('input[type=number]')] : [];
  const form = {
    'è¨€èª':              selects[0]?.value||'â€”',
    'å›³æ›¸ç•ªå·':          inputs[0]?.value||'â€”',
    'åŸºæº–å€¤ï¼ˆç›®æ¨™å€¤ï¼‰':  inputs[1]?.value||'â€”',
    'ä½œæˆæ—¥':            dateInp[0]?.value||TODAY,
    'ç”³è«‹å›æ•°':          selects[1]?.value||'â€”',
    'è¨ˆç”»æ™‚ã®æ¤œè¨¼äºˆå®šæ—¥':dateInp[1]?.value||TODAY,
    'æ¤œè¨¼ç¯„å›²':          inputs[2]?.value||'â€”',
    'æ¤œè¨¼å®Œäº†å¸Œæœ›æ—¥':    dateInp[2]?.value||TODAY,
    'å®Œäº†å¸Œæœ›æ™‚åˆ»':      acc?.querySelector('input[type=time]')?.value||'â€”',
    'ä½œæˆæ‹…å½“è€…':        inputs[3]?.value||'â€”',
    'ãƒšãƒ¼ã‚¸æ•°':          numInp[0]?.value||'â€”',
    'æ¤œè¨¼æ™‚é–“':          selects[2]?.value||'â€”',
    'ä¸å…·åˆä»¶æ•°':        numInp[1]?.value||'â€”',
    'æ¨™æº–ä¸å…·åˆä»¶æ•°':    numInp[2]?.value||'â€”',
    'æ›¸é¡æ¤œè¨¼å®Ÿæ–½æ¡ä»¶':  selects[3]?.value||'â€”',
    'é€šçŸ¥å…ˆ':            notify.join(' / ')||'ãªã—',
  };

  const now = new Date();
  const datetime = now.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'});
  d.history.push({act:'WFç”³è«‹',who:route[0].person,date:TODAY,datetime,type:'submitted',form,route,notify});
  wfFormOpen=false;
  render();
  openDetail(d);
  showToast('WFç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸ ğŸ“¤');
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2200);
}

init();
</script>
</body>
</html>
